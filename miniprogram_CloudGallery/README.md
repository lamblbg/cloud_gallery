# 云图廊

## 简介

实现小程序端的大文件上传。

## 关键技术

mongodb + node.js + 小程序 + vant

## 启动步骤

1. 进入项目目录
2. 安装依赖

```bash
npm install
```

3. 微信开发者工具打开

## 重点

1. 大文件分片上传 √
2. 上传进度监控 √
3. 图片压缩 √
4. 图片水印 √
5. 图片懒加载 √
6. wx.request二次封装 √
7. 保存为pdf ×
8. 文件秒传 ×

## 难点

1. 文件分片过后如何统计总体的上传进度？

    一开始想的是一个一个地上传，然后每上传完成一个就累计上传的大小，然后再和总大小做运算得出一个上传进度。但是这样会浪费网络带宽，且耗时较久，另外这个进度的精度还受到该上传任务大小的影响，如果太大了那么会看到进度突然飙升的情况。
    后面就改成异步上传，这样就能同时上传几个文件，但这样又怎么统计上传进度呢？我的做法是维护一个已上传大小的数组，每当上传任务onProgressUpdate事件发生时，便更改数组对应位置的数值，并同时统计数组所有元素的总和，再和总大小做运算得出一个上传进度。

2. 水印设置倾斜角度后，如何确保水印能覆盖到整张图片？

    刚开始想通过图片的高度和水印的倾斜角度计算出canvas的原点，通过重新设置canvas作画的原点达到目的，但是发现如果canvas的大小和图片一致时，无法将原点设置出画布外，所以我的解决办法是设置canvas的宽高为图片的两倍，图片画至画布的右下角，再设置原点为左下角，这时再画水印确保水印能覆盖到整张图片，当要显示预览或者导出水印图片时，就从原点为(图片的宽，图片的高)处裁剪，此处为有效图片的左上角。

## 其他点

### 登录

https://www.yuque.com/u33533426/uw71xu/idv1yoollz68bvgy#GZGOb

### 文件上传

你的文件上传是如何做的？

1. 获取待上传的文件列表，这个列表的每个元素都有可能是大文件、小文件
2. 压缩并获得新的文件列表，并计算压缩后的总体大小
3. 处理出一个新的待上传列表，此时如果有大文件将进行分片（调用ArrayBuffer的slice()进行切片），新的待上传列表形如：[小文件、大文件1的分片①、大文件1的分片②、大文件1的分片③、小文件、大文件2的分片①、大文件2的分片②]
4. 处理出一个待上传的任务列表
5. 待所有任务完成后，在结果数组中过滤出（我给每个任务加了对应的isChunk属性，据此可判断大小文件）小文件的上传结果；过滤出大文件分片的上传任务，然后根据fileHash去重，再请求合并资源
6. 最后获得所有任务的上传结果，更新数据库
